template: energinet-co2
products:
  - brand: Energinet
    description:
      generic: COâ‚‚
requirements:
  evcc: ["skiptest"]
group: co2
countries: ["DK"]
params:
  - name: region
    example: dk1
    type: choice
    choice: ["dk1", "dk2"]
    required: true
  - preset: tariff-base
render: |
  type: custom
  tariff: co2
  forecast:
    source: http
    uri: https://api.energidataservice.dk/dataset/CO2EmisProg?filter={"PriceArea":["{{ .region }}"]}&start=now&sort=Minutes5UTC%20DESC
    jq: |
      [.records[]
        | {
          minute: (.Minutes5UTC[14:16]),
          quarter: ((.Minutes5UTC[14:16] | tonumber) / 15 | floor * 15 | tostring),
          start: (.Minutes5UTC[0:13] + ":" + ((.Minutes5UTC[14:16] | tonumber) / 15 | floor * 15 | tostring) + ":00Z"),
          end: (
            (.Minutes5UTC[0:13] + ":" + ((.Minutes5UTC[14:16] | tonumber) / 15 | floor * 15 | tostring) + ":00Z")
            | strptime("%Y-%m-%dT%H:%M:%SZ")
            | mktime + 900
            | strftime("%Y-%m-%dT%H:%M:%SZ")
          ),
          value: .CO2Emission
        }
      ]
      | group_by(.start)
      | map({
          start: .[0].start,
          end: .[0].end,
          value: (map(.value) | add / length)
        })
      | tostring
